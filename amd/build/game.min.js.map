{"version":3,"file":"game.min.js","sources":["../src/game.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * TODO describe module game\n *\n * @module     mod_kahoodle/game\n * @copyright  Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as PubSub from 'core/pubsub';\nimport * as RealTimeEvents from 'tool_realtime/events';\nimport * as Notification from 'core/notification';\nimport * as RealTimeApi from 'tool_realtime/api';\nimport Templates from 'core/templates';\n\nconst SELECTORS = {\n    MAINDIV: '#mod_kahoodle_game[data-cmid][data-contextid]',\n    TRANSITIONBUTTON: '[data-action=\"transition\"]',\n    ANSWERBUTTON: '[data-action=\"answer\"][data-questionid]',\n\n};\n\nvar initialised = false;\n\nexport const init = () => {\n    if (initialised) {\n        return;\n    }\n    initialised = true;\n\n    PubSub.subscribe(RealTimeEvents.CONNECTION_LOST, (e) => {\n        window.console.log('Error', e);\n        Notification.exception({\n            name: 'Error',\n            message: 'Something went wrong, please refresh the page'});\n    });\n\n    PubSub.subscribe(RealTimeEvents.EVENT, (data) => {\n        window.console.log('received event ' + JSON.stringify(data));\n        var {context, contextid, component, payload} = data;\n        if (!contextid && context?.id) {\n            contextid = context.id;\n        }\n        window.console.log('-details-: ' + JSON.stringify({contextid: contextid, component, payload}));\n        const node = document.querySelector(SELECTORS.MAINDIV);\n        if (!payload || component != 'mod_kahoodle' || contextid != node.dataset.contextid) {\n            window.console.log('Ignoring event for different context or component');\n            return;\n        }\n\n        const updates = data.payload;\n        window.console.log('updates = ' + JSON.stringify(updates));\n        // Render updates.\n        if (!updates.template) {\n            window.console.error('Unexpected result - template is missing');\n        } else if (updates.data === undefined) {\n            window.console.error('Unexpected result - data is missing');\n        } else {\n            // TODO validate template and data.\n            Templates.render(updates.template, updates.data)\n            .then(function(html, js) {\n                // Append the link to the most suitable place on the page with fallback to legacy selectors and finally the body if\n                // there is no better place.\n                Templates.replaceNodeContents(node, html, js);\n\n                return null;\n            })\n            .catch(function(error) {\n                window.console.error('Error rendering template:', error);\n            });\n        }\n    });\n\n    document.addEventListener('click', (e) => {\n        const answerButton = e.target.closest(SELECTORS.MAINDIV + \" \" + SELECTORS.ANSWERBUTTON);\n        if (answerButton) {\n            doAnswer(parseInt(answerButton.dataset.questionid), parseInt(answerButton.dataset.optionid));\n        }\n        const transitionButton = e.target.closest(SELECTORS.MAINDIV + \" \" + SELECTORS.TRANSITIONBUTTON);\n        if (transitionButton) {\n            doTransition();\n        }\n    });\n};\n\nexport const doTransition = () => {\n    const node = document.querySelector(SELECTORS.MAINDIV);\n    RealTimeApi.sendToServer({\n        contextid: node.dataset.contextid,\n        component: 'mod_kahoodle',\n        area: 'game',\n        itemid: 0,\n    }, {\n        action: 'transition'\n    });\n};\n\nexport const doAnswer = (questionid, answer) => {\n    const node = document.querySelector(SELECTORS.MAINDIV);\n    RealTimeApi.sendToServer({\n        contextid: node.dataset.contextid,\n        component: 'mod_kahoodle',\n        area: 'game',\n        itemid: parseInt(node.dataset.playerid ?? 0)\n    }, {\n        action: 'answer',\n        questionid,\n        answer\n    });\n};\n"],"names":["SELECTORS","initialised","PubSub","subscribe","RealTimeEvents","CONNECTION_LOST","e","window","console","log","Notification","exception","name","message","EVENT","data","JSON","stringify","context","contextid","component","payload","id","node","document","querySelector","dataset","updates","template","undefined","error","render","then","html","js","replaceNodeContents","catch","addEventListener","answerButton","target","closest","doAnswer","parseInt","questionid","optionid","doTransition","RealTimeApi","sendToServer","area","itemid","action","answer","playerid"],"mappings":";;;;;;;gYA6BMA,kBACO,gDADPA,2BAEgB,6BAFhBA,uBAGY,8CAIdC,aAAc,gBAEE,KACZA,cAGJA,aAAc,EAEdC,OAAOC,UAAUC,eAAeC,iBAAkBC,IAC9CC,OAAOC,QAAQC,IAAI,QAASH,GAC5BI,aAAaC,UAAU,CACnBC,KAAM,QACNC,QAAS,qDAGjBX,OAAOC,UAAUC,eAAeU,OAAQC,OACpCR,OAAOC,QAAQC,IAAI,kBAAoBO,KAAKC,UAAUF,WAClDG,QAACA,QAADC,UAAUA,UAAVC,UAAqBA,UAArBC,QAAgCA,SAAWN,MAC1CI,WAAD,MAAcD,SAAAA,QAASI,KACvBH,UAAYD,QAAQI,IAExBf,OAAOC,QAAQC,IAAI,cAAgBO,KAAKC,UAAU,CAACE,UAAWA,UAAWC,UAAAA,UAAWC,QAAAA,iBAC9EE,KAAOC,SAASC,cAAczB,uBAC/BqB,SAAwB,gBAAbD,WAA+BD,WAAaI,KAAKG,QAAQP,sBACrEZ,OAAOC,QAAQC,IAAI,2DAIjBkB,QAAUZ,KAAKM,QACrBd,OAAOC,QAAQC,IAAI,aAAeO,KAAKC,UAAUU,UAE5CA,QAAQC,cAEeC,IAAjBF,QAAQZ,KACfR,OAAOC,QAAQsB,MAAM,0DAGXC,OAAOJ,QAAQC,SAAUD,QAAQZ,MAC1CiB,MAAK,SAASC,KAAMC,8BAGPC,oBAAoBZ,KAAMU,KAAMC,IAEnC,QAEVE,OAAM,SAASN,OACZvB,OAAOC,QAAQsB,MAAM,4BAA6BA,UAdtDvB,OAAOC,QAAQsB,MAAM,8CAmB7BN,SAASa,iBAAiB,SAAU/B,UAC1BgC,aAAehC,EAAEiC,OAAOC,QAAQxC,kBAAoB,IAAMA,wBAC5DsC,cACAG,SAASC,SAASJ,aAAaZ,QAAQiB,YAAaD,SAASJ,aAAaZ,QAAQkB,WAE7DtC,EAAEiC,OAAOC,QAAQxC,kBAAoB,IAAMA,6BAEhE6C,0BAKCA,aAAe,WAClBtB,KAAOC,SAASC,cAAczB,mBACpC8C,YAAYC,aAAa,CACrB5B,UAAWI,KAAKG,QAAQP,UACxBC,UAAW,eACX4B,KAAM,OACNC,OAAQ,GACT,CACCC,OAAQ,yDAIHT,SAAW,CAACE,WAAYQ,0CAC3B5B,KAAOC,SAASC,cAAczB,mBACpC8C,YAAYC,aAAa,CACrB5B,UAAWI,KAAKG,QAAQP,UACxBC,UAAW,eACX4B,KAAM,OACNC,OAAQP,uCAASnB,KAAKG,QAAQ0B,gEAAY,IAC3C,CACCF,OAAQ,SACRP,WAAAA,WACAQ,OAAAA"}